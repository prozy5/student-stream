<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Watch â€“ SS Films</title>

<style>
body{
  margin:0;
  background:#05070c;
  color:#fff;
  font-family:system-ui;
}

header{
  padding:14px 18px;
  border-bottom:1px solid #1f2630;
  font-weight:800;
}

.player-wrap{
  position:relative;
  max-width:900px;
  margin:20px auto;
  background:black;
}

video{
  width:100%;
  height:auto;
  background:black;
}

/* ---------- AD OVERLAY ---------- */

#adOverlay{
  position:absolute;
  inset:0;
  background:black;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:5;
}

#adOverlay video{
  width:100%;
  height:100%;
  object-fit:contain;
}

#skipBtn{
  position:absolute;
  right:15px;
  top:15px;
  background:#111;
  color:#fff;
  border:1px solid #444;
  padding:8px 12px;
  border-radius:6px;
  cursor:not-allowed;
  opacity:.6;
}

#skipBtn.enabled{
  cursor:pointer;
  opacity:1;
}

/* ---------- BANNER AD ---------- */

#bannerAd{
  position:absolute;
  bottom:20px;
  right:20px;
  width:260px;
  background:#000d;
  border-radius:10px;
  overflow:hidden;
  display:none;
  z-index:4;
}

#bannerAd img{
  width:100%;
  display:block;
}

#bannerAd a{
  display:block;
  color:white;
  text-decoration:none;
  font-size:13px;
  padding:6px;
  text-align:center;
}

/* ---------- INFO ---------- */

.info{
  max-width:900px;
  margin:auto;
  padding:10px 18px;
}

</style>
</head>
<body>

<header>ðŸŽ¬ SS Films</header>

<div class="player-wrap">

  <!-- PRE-ROLL AD -->
  <div id="adOverlay" style="display:none">
    <video id="adVideo"></video>
    <button id="skipBtn">Skip in 5</button>
  </div>

  <!-- MAIN VIDEO -->
  <video id="filmVideo" controls></video>

  <!-- BANNER AD -->
  <div id="bannerAd">
    <a id="bannerLink" target="_blank">
      <img id="bannerImg">
      <div>Sponsored</div>
    </a>
  </div>

</div>

<div class="info">
  <h2 id="title"></h2>
  <p id="desc"></p>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

const params = new URLSearchParams(location.search);
const filmId = params.get("id");

const filmVideo = document.getElementById("filmVideo");
const adOverlay = document.getElementById("adOverlay");
const adVideo = document.getElementById("adVideo");
const skipBtn = document.getElementById("skipBtn");

const bannerAd = document.getElementById("bannerAd");
const bannerImg = document.getElementById("bannerImg");
const bannerLink = document.getElementById("bannerLink");

let skipTimer = 5;

/* ---------------- LOAD FILM ---------------- */

async function loadFilm(){
  const { data } = await supabase
    .from("films")
    .select("*")
    .eq("id", filmId)
    .single();

  document.getElementById("title").innerText = data.title;
  document.getElementById("desc").innerText = data.description;
  filmVideo.src = data.video_url;

  await playPreRollAd();
}

/* ---------------- PREROLL ADS ---------------- */

async function playPreRollAd(){

  const { data:ads } = await supabase
    .from("ads")
    .select("*")
    .eq("active", true)
    .eq("ad_type", "preroll")
    .limit(1);

  if(!ads || ads.length === 0){
    filmVideo.play();
    loadBannerAd();
    return;
  }

  const ad = ads[0];

  adOverlay.style.display = "flex";
  adVideo.src = ad.video_url;
  adVideo.play();

  startSkipTimer();

  adVideo.onended = ()=>{
    finishAd(ad);
  };
}

function startSkipTimer(){
  skipBtn.innerText = `Skip in ${skipTimer}`;
  const timer = setInterval(()=>{
    skipTimer--;
    if(skipTimer <= 0){
      clearInterval(timer);
      skipBtn.innerText = "Skip Ad";
      skipBtn.classList.add("enabled");
      skipBtn.onclick = ()=> finishAd();
    }else{
      skipBtn.innerText = `Skip in ${skipTimer}`;
    }
  },1000);
}

function finishAd(ad=null){
  adOverlay.style.display="none";
  adVideo.pause();
  filmVideo.play();
  loadBannerAd();

  if(ad){
    trackAdView(ad.id);
  }
}

/* ---------------- BANNER ADS ---------------- */

async function loadBannerAd(){
  const { data:ads } = await supabase
    .from("ads")
    .select("*")
    .eq("active", true)
    .eq("ad_type", "overlay")
    .limit(1);

  if(!ads || ads.length === 0) return;

  const ad = ads[0];

  bannerImg.src = ad.image_url;
  bannerLink.href = ad.click_url || "#";
  bannerAd.style.display="block";

  trackAdView(ad.id);
}

/* ---------------- TRACKING ---------------- */

async function trackAdView(adId){
  const { data:{ user } } = await supabase.auth.getUser();

  await supabase.from("ad_views").insert({
    ad_id: adId,
    film_id: filmId,
    viewer_id: user?.id || null,
    watched_seconds: 5
  });

  // Revenue calculation handled later by SQL function / backend
}

/* ---------------- INIT ---------------- */

loadFilm();

</script>

</body>
</html>