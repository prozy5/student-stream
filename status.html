<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0b0f1a;
  color: #eaeaf0;
}

header {
  padding: 24px;
  background: #0f1629;
  border-bottom: 1px solid #1e2a4a;
}

h1 {
  margin: 0;
  font-size: 22px;
}

.container {
  max-width: 900px;
  margin: auto;
  padding: 20px;
}

.component {
  display: flex;
  justify-content: space-between;
  padding: 14px;
  margin-bottom: 10px;
  background: #121a33;
  border-radius: 10px;
  border: 1px solid #1e2a4a;
}

.status-ok { color: #4ade80; }
.status-down { color: #f87171; }
.status-degraded { color: #facc15; }

.incident {
  background: #1a1220;
  border: 1px solid #3b1a55;
  padding: 14px;
  border-radius: 10px;
  margin-bottom: 10px;
}

.loading {
  opacity: 0.6;
}

.error {
  background: #2a1111;
  color: #ffb4b4;
  padding: 12px;
  border-radius: 8px;
}
</style>
</head>

<body>

<header>
  <h1>ðŸš¦ StudentStream System Status</h1>
</header>

<div class="container">

<h2>System Components</h2>
<div id="components" class="loading">Loading componentsâ€¦</div>

<h2>Incidents</h2>
<div id="incidents" class="loading">Loading incidentsâ€¦</div>

<div id="errors"></div>

</div>

<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const componentsDiv = document.getElementById("components");
const incidentsDiv = document.getElementById("incidents");
const errorsDiv = document.getElementById("errors");

function statusClass(status) {
  if (!status) return "";
  status = status.toLowerCase();
  if (status.includes("operational")) return "status-ok";
  if (status.includes("down")) return "status-down";
  if (status.includes("degraded")) return "status-degraded";
  return "";
}

async function loadComponents() {
  const { data, error } = await supabase
    .from("status_components")
    .select("*")
    .order("order_index", { ascending: true });

  if (error) {
    showError(error);
    componentsDiv.textContent = "Failed to load components.";
    return;
  }

  componentsDiv.classList.remove("loading");
  componentsDiv.innerHTML = "";

  if (!data.length) {
    componentsDiv.textContent = "No components found.";
    return;
  }

  data.forEach(c => {
    const el = document.createElement("div");
    el.className = "component";
    el.innerHTML = `
      <div>${c.name}</div>
      <div class="${statusClass(c.status)}">${c.status}</div>
    `;
    componentsDiv.appendChild(el);
  });
}

async function loadIncidents() {
  const { data, error } = await supabase
    .from("status_incidents")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(5);

  if (error) {
    showError(error);
    incidentsDiv.textContent = "Failed to load incidents.";
    return;
  }

  incidentsDiv.classList.remove("loading");
  incidentsDiv.innerHTML = "";

  if (!data.length) {
    incidentsDiv.textContent = "No active incidents ðŸŽ‰";
    return;
  }

  data.forEach(i => {
    const el = document.createElement("div");
    el.className = "incident";
    el.innerHTML = `
      <strong>${i.title}</strong><br>
      <small>${new Date(i.created_at).toLocaleString()}</small>
      <p>${i.description || ""}</p>
    `;
    incidentsDiv.appendChild(el);
  });
}

function showError(err) {
  console.error(err);
  const div = document.createElement("div");
  div.className = "error";
  div.textContent = err.message || JSON.stringify(err);
  errorsDiv.appendChild(div);
}

function subscribeRealtime() {
  supabase.channel("status-realtime")
    .on("postgres_changes", { event: "*", schema: "public", table: "status_components" }, loadComponents)
    .on("postgres_changes", { event: "*", schema: "public", table: "status_incidents" }, loadIncidents)
    .subscribe();
}

async function init() {
  await loadComponents();
  await loadIncidents();
  subscribeRealtime();
}

init();
</script>

</body>
</html>