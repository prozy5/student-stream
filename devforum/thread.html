<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Thread – StudentStream DevForum</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b1020;color:#fff}
header{padding:14px;background:#111736;font-weight:600}
.container{max-width:800px;margin:auto;padding:14px}

.thread-box,.reply{
background:#141b3a;
padding:12px;
border-radius:10px;
margin-bottom:12px;
}

.author{font-size:13px;color:#aaa}
.staff{color:#ffd36a;font-weight:600;margin-left:6px}

.reply-box{display:flex;gap:8px;margin-top:12px}
textarea{flex:1;padding:10px;border-radius:8px;border:none}
button{padding:10px 14px;border:none;border-radius:8px;background:#6a7cff;color:#fff}

.mod-btn{color:#ff7a7a;font-size:12px;cursor:pointer;margin-left:8px}
</style>
</head>
<body>

<header>
<a href="index.html" style="color:#8fa0ff;text-decoration:none">← Back</a>
</header>

<div class="container">

<div id="thread"></div>

<h3>Replies</h3>
<div id="replies"></div>

<div class="reply-box">
<textarea id="replyText" placeholder="Write a reply..."></textarea>
<button onclick="sendReply()">Send</button>
</div>

</div>

<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const params = new URLSearchParams(location.search);
const threadId = params.get("id");

let me = null;
let isStaff = false;

init();

async function init(){
const {data:{user}} = await supabase.auth.getUser();
me = user?.id || null;

if(me){
const p = await supabase.from("profiles").select("*").eq("id",me).single();
if(p.data) isStaff = p.data.is_staff;
}

loadThread();
loadReplies();
subscribeReplies();
}

async function loadThread(){
const {data} = await supabase.from("threads").select("*").eq("id",threadId).single();
document.getElementById("thread").innerHTML = `
<div class="thread-box">
<h2>${data.title}</h2>
<p>${data.content}</p>
<div class="author">Posted by ${short(data.user_id)}</div>
${isStaff ? `<span class="mod-btn" onclick="deleteThread()">Delete Thread</span>` : ""}
</div>
`;
}

async function loadReplies(){
const {data} = await supabase.from("replies").select("*").eq("thread_id",threadId).order("created_at");
renderReplies(data);
}

function renderReplies(list){
const box = document.getElementById("replies");
box.innerHTML="";
list.forEach(r=>{
box.innerHTML += `
<div class="reply">
<div>${r.content}</div>
<div class="author">
${short(r.user_id)}
${r.is_staff?'<span class="staff">STAFF</span>':''}
${isStaff?`<span class="mod-btn" onclick="deleteReply('${r.id}')">Delete</span>`:""}
</div>
</div>
`;
});
}

async function sendReply(){
const text = replyText.value.trim();
if(!text) return;

await supabase.from("replies").insert({
thread_id: threadId,
content: text,
user_id: me
});

replyText.value="";
}

function subscribeReplies(){
supabase.channel("replies")
.on("postgres_changes",{event:"INSERT",table:"replies",filter:`thread_id=eq.${threadId}`},payload=>{
loadReplies();
})
.subscribe();
}

async function deleteReply(id){
if(!confirm("Delete reply?")) return;
await supabase.from("replies").delete().eq("id",id);
loadReplies();
}

async function deleteThread(){
if(!confirm("Delete thread?")) return;
await supabase.from("threads").delete().eq("id",threadId);
location.href="index.html";
}

function short(id){
if(!id) return "Guest";
return id.slice(0,6);
}
</script>

</body>
</html>
