<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SS Films</title>

<style>
body{margin:0;background:#0b0f14;color:#fff;font-family:sans-serif}
header{display:flex;align-items:center;justify-content:space-between;padding:14px}
.logo{font-size:22px;font-weight:bold}
.search{background:#1a1f27;border:none;color:#fff;padding:8px 12px;border-radius:6px;width:160px}

.section{padding:10px}
.section h2{margin:10px 0;font-size:18px}

.row{display:flex;gap:10px;overflow-x:auto;padding-bottom:10px}
.row::-webkit-scrollbar{display:none}

.card{min-width:140px;cursor:pointer;position:relative}
.card img{width:140px;height:200px;border-radius:8px;object-fit:cover}
.title{font-size:13px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.meta{font-size:11px;opacity:.8}
.badge{background:#1e90ff;font-size:10px;padding:2px 5px;border-radius:4px;margin-left:4px}

.progress{height:4px;background:#222;border-radius:2px;margin-top:4px;overflow:hidden}
.progress span{display:block;height:100%;background:#1e90ff}

.like{position:absolute;top:6px;right:6px;background:#0009;border-radius:50%;padding:4px;font-size:12px}
.like.active{color:red}

.hero{text-align:center;padding:30px;opacity:.7}
</style>
</head>
<body>

<header>
  <div class="logo">SS Films</div>
  <input id="search" class="search" placeholder="Search films...">
</header>

<div id="continueSection" class="section"></div>
<div id="trendingSection" class="section"></div>
<div id="categoriesSection"></div>
<div id="empty" class="hero" style="display:none">No films uploaded yet</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient("https://iabzmoxzbqzcqgypxctr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ");

const continueSection = document.getElementById("continueSection");
const trendingSection = document.getElementById("trendingSection");
const categoriesSection = document.getElementById("categoriesSection");
const searchInput = document.getElementById("search");

let films=[], progressMap={}, likedSet=new Set();

async function getUser(){
  const {data:{user}} = await supabase.auth.getUser();
  return user;
}

function filmCard(f){
  const progress = progressMap[f.id] || 0;
  const liked = likedSet.has(f.id);

  return `
  <div class="card">
    <div class="like ${liked?'active':''}" onclick="toggleLike(event,'${f.id}')">‚ù§Ô∏è</div>
    <img src="${f.thumbnail_url}" onclick="openWatch('${f.id}')">
    <div class="title">${f.title}</div>
    <div class="meta">
      üëÅ ${f.views||0} ‚ù§Ô∏è ${f.likes||0}
      ${f.creator_name?`<span class="badge">${f.creator_name}</span>`:""}
    </div>
    ${progress?`<div class="progress"><span style="width:${progress}%"></span></div>`:""}
  </div>`;
}

window.openWatch=id=>{
  location.href=`watch.html?id=${id}`;
}

window.toggleLike=async(e,id)=>{
  e.stopPropagation();
  const user = await getUser();
  if(!user) return alert("Login required");

  if(likedSet.has(id)){
    await supabase.from("film_likes").delete().eq("film_id",id).eq("user_id",user.id);
    likedSet.delete(id);
  }else{
    await supabase.from("film_likes").insert({film_id:id,user_id:user.id});
    likedSet.add(id);
  }
  loadAll();
}

async function loadProgress(){
  const user = await getUser();
  if(!user) return;

  const {data}=await supabase.from("film_progress").select("film_id,progress").eq("user_id",user.id);
  data?.forEach(p=>progressMap[p.film_id]=p.progress);
}

async function loadLikes(){
  const user = await getUser();
  if(!user) return;

  const {data}=await supabase.from("film_likes").select("film_id").eq("user_id",user.id);
  data?.forEach(l=>likedSet.add(l.film_id));
}

async function loadFilms(){
  const {data}=await supabase.from("films")
  .select("id,title,thumbnail_url,views,likes,is_series,film_creators(name)");

  films=data.map(f=>({...f,creator_name:f.film_creators?.name}));
}

function buildRow(title,list,target){
  if(!list.length) return;
  target.innerHTML+=`
  <h2>${title}</h2>
  <div class="row">${list.map(filmCard).join("")}</div>`;
}

function loadContinue(){
  const items=films.filter(f=>progressMap[f.id]>0);
  if(!items.length) return;

  continueSection.innerHTML="";
  buildRow("Continue Watching",items,continueSection);
}

function loadTrending(){
  const trending=[...films].sort((a,b)=>(b.views||0)-(a.views||0)).slice(0,10);
  trendingSection.innerHTML="";
  buildRow("Trending",trending,trendingSection);
}

async function loadCategories(){
  categoriesSection.innerHTML="";
  const {data:cats}=await supabase.from("film_categories").select("id,name");

  for(const c of cats){
    const {data:maps}=await supabase.from("film_category_map").select("film_id").eq("category_id",c.id);
    const catFilms=maps.map(m=>films.find(f=>f.id===m.film_id)).filter(Boolean);
    if(catFilms.length){
      const div=document.createElement("div");
      div.className="section";
      buildRow(c.name,catFilms,div);
      categoriesSection.appendChild(div);
    }
  }
}

searchInput.oninput=()=>{
  const q=searchInput.value.toLowerCase();
  categoriesSection.innerHTML=`<div class="section"><h2>Search Results</h2><div class="row">${
    films.filter(f=>f.title.toLowerCase().includes(q)).map(filmCard).join("")
  }</div></div>`;
}

async function loadAll(){
  progressMap={}; likedSet.clear();
  await loadProgress();
  await loadLikes();
  await loadFilms();

  if(!films.length) document.getElementById("empty").style.display="block";

  loadContinue();
  loadTrending();
  loadCategories();
}

loadAll();
</script>

</body>
</html>