<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Film â€“ SS Films</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#05070d;
  color:#fff;
  font-family:system-ui,Segoe UI,Roboto;
}

header{
  padding:16px 22px;
  font-weight:800;
  font-size:20px;
  background:#000;
}

.container{
  max-width:600px;
  margin:auto;
  padding:20px;
}

input, textarea, select, button{
  width:100%;
  padding:12px;
  margin-bottom:14px;
  border-radius:8px;
  border:none;
  background:#111;
  color:white;
}

button{
  background:#e50914;
  font-weight:700;
  cursor:pointer;
}

button:disabled{
  opacity:.6;
}

.status{
  margin-top:10px;
  font-size:14px;
  opacity:.85;
}
</style>
</head>
<body>

<header>Upload to SS Films</header>

<div class="container">

  <div id="authStatus"></div>

  <form id="uploadForm" style="display:none">

    <input type="text" id="title" placeholder="Film title" required>

    <textarea id="description" placeholder="Description"></textarea>

    <select id="category"></select>

    <label>Video file</label>
    <input type="file" id="videoFile" accept="video/*" required>

    <label>Thumbnail image</label>
    <input type="file" id="thumbFile" accept="image/*">

    <button type="submit">Upload Film</button>

    <div class="status" id="status"></div>
  </form>

</div>

<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const form = document.getElementById("uploadForm");
const statusEl = document.getElementById("status");
const authStatus = document.getElementById("authStatus");

async function init(){

  const { data: { session } } = await supabase.auth.getSession();

  if(!session){
    authStatus.innerHTML = `You must <a href="/auth/login.html">login</a> to upload films.`;
    return;
  }

  form.style.display = "block";

  loadCategories();
}

async function loadCategories(){
  const { data } = await supabase.from("film_categories").select("*");

  const select = document.getElementById("category");

  data.forEach(cat=>{
    const opt = document.createElement("option");
    opt.value = cat.id;
    opt.textContent = cat.name;
    select.appendChild(opt);
  });
}

form.addEventListener("submit", async (e)=>{
  e.preventDefault();

  statusEl.textContent = "Uploading...";

  const title = document.getElementById("title").value;
  const desc = document.getElementById("description").value;
  const categoryId = document.getElementById("category").value;
  const videoFile = document.getElementById("videoFile").files[0];
  const thumbFile = document.getElementById("thumbFile").files[0];

  const user = (await supabase.auth.getUser()).data.user;

  const videoPath = `${user.id}/${Date.now()}_${videoFile.name}`;
  const thumbPath = thumbFile ? `${user.id}/${Date.now()}_${thumbFile.name}` : null;

  // Upload video
  const { error: videoErr } = await supabase.storage
    .from("films")
    .upload(videoPath, videoFile);

  if(videoErr){
    statusEl.textContent = "Video upload failed.";
    return;
  }

  // Upload thumbnail
  let thumbUrl = null;
  if(thumbFile){
    const { error: thumbErr } = await supabase.storage
      .from("thumbnails")
      .upload(thumbPath, thumbFile);

    if(!thumbErr){
      thumbUrl = supabase.storage.from("thumbnails").getPublicUrl(thumbPath).data.publicUrl;
    }
  }

  const videoUrl = supabase.storage.from("films").getPublicUrl(videoPath).data.publicUrl;

  // Insert into database
  const { error: dbErr } = await supabase.from("films").insert({
    title: title,
    description: desc,
    category_id: categoryId,
    video_url: videoUrl,
    thumbnail_url: thumbUrl,
    is_published: true,
    is_featured: false
  });

  if(dbErr){
    statusEl.textContent = "Database insert failed.";
    console.error(dbErr);
    return;
  }

  statusEl.textContent = "Upload successful!";

  form.reset();
});

init();
</script>

</body>
</html>