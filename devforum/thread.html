<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Thread</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0d14;color:white;font-family:sans-serif;padding:20px}
.post{padding:12px;border-bottom:1px solid #1f2933}
textarea{width:100%;height:80px}
button{padding:8px 12px;background:#4f46e5;border:none;color:white;border-radius:6px}
.badge{font-size:10px;padding:3px 6px;border-radius:5px}
.owner{background:#facc15;color:black}
.admin{background:#ef4444}
.mod{background:#3b82f6}
</style>
</head>
<body>

<h2 id="title"></h2>
<div id="posts"></div>

<textarea id="msg"></textarea>
<button onclick="send()">Reply</button>

<script>
const supabase=supabase.createClient("URL","KEY")
const params=new URLSearchParams(location.search)
const threadId=params.get("id")

let user,profile

async function init(){
 const res=await supabase.auth.getUser()
 if(!res.data.user){location.href="/auth.html";return}
 user=res.data.user
 profile=(await supabase.from("profiles").select("*").eq("id",user.id).single()).data

 loadThread()
 loadPosts()
 subscribeRealtime()
}

async function loadThread(){
 const {data}=await supabase.from("forum_threads").select("*").eq("id",threadId).single()
 title.innerText=data.title
}

async function loadPosts(){
 const {data}=await supabase.from("forum_posts")
 .select("*,profiles(username,role)")
 .eq("thread_id",threadId)
 .order("created_at")

 const box=document.getElementById("posts")
 box.innerHTML=""

 data.forEach(p=>{
   let badge=""
   if(p.profiles.role==="owner") badge=`<span class="badge owner">FOUNDER</span>`
   if(p.profiles.role==="admin") badge=`<span class="badge admin">ADMIN</span>`
   if(p.profiles.role==="mod") badge=`<span class="badge mod">MOD</span>`

   box.innerHTML+=`
   <div class="post">
     <b>${p.profiles.username}</b> ${badge}
     <div>${p.content}</div>
   </div>`
 })
}

async function send(){
 if(!msg.value)return
 await supabase.from("forum_posts").insert({
   thread_id:threadId,
   user_id:user.id,
   content:msg.value
 })
 msg.value=""
}

function subscribeRealtime(){
 supabase.channel("forum")
 .on("postgres_changes",{event:"INSERT",table:"forum_posts",filter:`thread_id=eq.${threadId}`},payload=>{
   loadPosts()
 })
 .subscribe()
}

init()
</script>

</body>
</html>