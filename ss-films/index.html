<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SS Films</title>

<style>
*{box-sizing:border-box}
body{margin:0;background:#0b0f14;color:#fff;font-family:system-ui,-apple-system,sans-serif}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
  border-bottom:1px solid #1c2230;
}

.logo{font-size:20px;font-weight:700}

.actions{display:flex;gap:10px}

.btn{
  padding:7px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-size:13px;
}

.btn.primary{background:#1e90ff;color:#fff}
.btn.outline{background:transparent;border:1px solid #2a3550;color:#fff}

.section{padding:16px}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:12px;
}

.card{
  cursor:pointer;
}

.card img{
  width:100%;
  aspect-ratio:2/3;
  border-radius:8px;
  object-fit:cover;
}

.title{
  font-size:13px;
  margin-top:6px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.hero{
  padding:40px 16px;
  text-align:center;
  opacity:.8
}

.creator-banner{
  margin:16px;
  padding:16px;
  background:#121826;
  border:1px solid #1f2a40;
  border-radius:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
</style>
</head>
<body>

<header>
  <div class="logo">SS Films</div>
  <div class="actions" id="authButtons"></div>
</header>

<div id="creatorBanner"></div>

<div class="section">
  <h2>Latest Films</h2>
  <div id="filmsGrid" class="grid"></div>
</div>

<div id="empty" class="hero" style="display:none">
  No films yet.
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

const filmsGrid = document.getElementById("filmsGrid");
const authButtons = document.getElementById("authButtons");
const creatorBanner = document.getElementById("creatorBanner");

async function getUser(){
  const { data:{user} } = await supabase.auth.getUser();
  return user;
}

function renderAuth(user){
  if(user){
    authButtons.innerHTML = `
      <button class="btn outline" onclick="logout()">Logout</button>
      <button class="btn primary" onclick="goUpload()">Upload</button>
    `;
  } else {
    authButtons.innerHTML = `
      <button class="btn outline" onclick="goLogin()">Login</button>
      <button class="btn primary" onclick="goSignup()">Sign Up</button>
    `;
  }
}

function filmCard(f){
  return `
    <div class="card" onclick="watch('${f.id}')">
      <img src="${f.thumbnail_url}">
      <div class="title">${f.title}</div>
    </div>
  `;
}

async function loadFilms(){
  const { data, error } = await supabase
    .from("films")
    .select("id,title,thumbnail_url")
    .eq("is_published", true)
    .order("created_at",{ascending:false});

  if(error){
    console.error(error);
    return;
  }

  if(!data.length){
    document.getElementById("empty").style.display="block";
    return;
  }

  filmsGrid.innerHTML = data.map(filmCard).join("");
}

async function checkCreator(user){
  if(!user) return;

  const { data } = await supabase
    .from("creators")
    .select("id")
    .eq("user_id", user.id)
    .single();

  if(!data){
    creatorBanner.innerHTML = `
      <div class="creator-banner">
        <div>
          <strong>Become a Creator</strong><br>
          Upload films and build your channel
        </div>
        <button class="btn primary" onclick="goCreatorApply()">Apply</button>
      </div>
    `;
  }
}

window.watch = id => location.href = `watch.html?id=${id}`;
window.goLogin = () => location.href = "login.html";
window.goSignup = () => location.href = "signup.html";
window.goUpload = () => location.href = "upload.html";
window.goCreatorApply = () => location.href = "creator-apply.html";

window.logout = async ()=>{
  await supabase.auth.signOut();
  location.reload();
}

async function init(){
  const user = await getUser();
  renderAuth(user);
  await loadFilms();
  await checkCreator(user);
}

init();
</script>

</body>
</html>