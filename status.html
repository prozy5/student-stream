<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream System Status</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
--bg:#0b0f1a;
--card:#121a2a;
--accent:#6c7cff;
--good:#22c55e;
--warn:#facc15;
--bad:#ef4444;
}

body {
margin:0;
font-family:system-ui,Segoe UI,Roboto;
background:linear-gradient(135deg,#0b0f1a,#0e1530);
color:#e5e7eb;
}

header {
display:flex;
justify-content:space-between;
align-items:center;
padding:20px 30px;
border-bottom:1px solid #1f2a44;
}

h1 { margin:0;font-size:22px; }

.badge {
padding:6px 14px;
border-radius:999px;
font-weight:600;
font-size:13px;
}

.grid {
display:grid;
grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
gap:16px;
padding:25px;
}

.card {
background:var(--card);
padding:16px;
border-radius:12px;
border:1px solid #1f2a44;
}

.component {
display:flex;
justify-content:space-between;
margin:8px 0;
}

.status-good {color:var(--good)}
.status-warn {color:var(--warn)}
.status-bad {color:var(--bad)}

.incident {
border-left:4px solid var(--warn);
padding-left:10px;
margin:10px 0;
}

.admin {
display:none;
margin:25px;
padding:20px;
border:1px solid #334155;
border-radius:12px;
background:#0f172a;
}

input,textarea,select,button {
background:#0b1222;
color:white;
border:1px solid #334155;
padding:8px;
border-radius:6px;
margin:4px 0;
}

button {
cursor:pointer;
background:var(--accent);
border:none;
}
</style>
</head>
<body>

<header>
<h1>StudentStream System Status</h1>
<span id="globalStatus" class="badge">Loading...</span>
</header>

<section class="grid">
<div class="card">
<h3>Components</h3>
<div id="components"></div>
</div>

<div class="card">
<h3>Incidents</h3>
<div id="incidents"></div>
</div>
</section>

<section class="admin" id="adminPanel">
<h3>Admin Panel</h3>

<h4>Add / Update Component</h4>
<input id="compName" placeholder="Component name">
<select id="compStatus">
<option value="operational">Operational</option>
<option value="degraded">Degraded</option>
<option value="down">Down</option>
</select>
<button onclick="saveComponent()">Save</button>

<h4>Create Incident</h4>
<input id="incTitle" placeholder="Title">
<textarea id="incDesc" placeholder="Description"></textarea>
<button onclick="createIncident()">Create Incident</button>
</section>

<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC";
const OWNER_UID = "0801d47e-6bc7-4916-bf0a-e2de667d21ea";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

async function initAuth(){
const { data } = await supabase.auth.getUser();
if(data.user){
currentUser = data.user;
if(data.user.id === OWNER_UID){
document.getElementById("adminPanel").style.display="block";
}
}
}

function statusColor(status){
if(status==="operational") return "status-good";
if(status==="degraded") return "status-warn";
return "status-bad";
}

async function loadComponents(){
const { data } = await supabase.from("status_components").select("*").order("id");
const box = document.getElementById("components");
box.innerHTML="";
let global="operational";

data.forEach(c=>{
if(c.status==="down") global="down";
if(c.status==="degraded" && global!=="down") global="degraded";

box.innerHTML += `
<div class="component">
<span>${c.name}</span>
<span class="${statusColor(c.status)}">${c.status}</span>
</div>`;
});

setGlobal(global);
}

async function loadIncidents(){
const { data } = await supabase.from("status_incidents")
.select("*").order("created_at",{ascending:false});

const box=document.getElementById("incidents");
box.innerHTML="";

if(!data.length){
box.innerHTML="<p>No active incidents.</p>";
return;
}

data.forEach(i=>{
box.innerHTML+=`
<div class="incident">
<strong>${i.title}</strong><br>
${i.description}<br>
<small>${new Date(i.created_at).toLocaleString()}</small>
</div>`;
});
}

function setGlobal(status){
const el=document.getElementById("globalStatus");
if(status==="operational"){
el.textContent="Operational";
el.style.background="var(--good)";
} else if(status==="degraded"){
el.textContent="Degraded";
el.style.background="var(--warn)";
} else {
el.textContent="Major Outage";
el.style.background="var(--bad)";
}
}

async function saveComponent(){
const name=document.getElementById("compName").value;
const status=document.getElementById("compStatus").value;
if(!name) return alert("Name required");

const { data:existing } = await supabase
.from("status_components").select("*").eq("name",name).single();

if(existing){
await supabase.from("status_components")
.update({status}).eq("id",existing.id);
} else {
await supabase.from("status_components")
.insert({name,status});
}

loadComponents();
}

async function createIncident(){
const title=document.getElementById("incTitle").value;
const description=document.getElementById("incDesc").value;

if(!title) return alert("Title required");

await supabase.from("status_incidents")
.insert({title,description,status:"open"});

loadIncidents();
}

function setupRealtime(){
supabase.channel("status-updates")
.on("postgres_changes",{event:"*",schema:"public",table:"status_components"},loadComponents)
.on("postgres_changes",{event:"*",schema:"public",table:"status_incidents"},loadIncidents)
.subscribe();
}

async function init(){
await initAuth();
await loadComponents();
await loadIncidents();
setupRealtime();
}

init();
</script>

</body>
</html>
