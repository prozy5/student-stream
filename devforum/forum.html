<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>StudentStream DevForum</title>
<link rel="stylesheet" href="forum.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<div class="topbar">
  <h2>StudentStream DevForum</h2>
  <a href="new.html" class="new-btn">+ New Thread</a>
</div>

<div id="status">Loading threads…</div>
<div id="threads"></div>

<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "PASTE_YOUR_REAL_ANON_KEY_HERE";

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

const threadsDiv = document.getElementById("threads");
const statusDiv = document.getElementById("status");

function escapeHtml(text) {
  const div = document.createElement("div");
  div.innerText = text;
  return div.innerHTML;
}

async function loadThreads() {
  statusDiv.textContent = "Loading threads…";

  const { data, error } = await supabase
    .from("forum_posts")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    statusDiv.textContent = "Failed to load threads.";
    console.error(error);
    return;
  }

  statusDiv.textContent = "";

  threadsDiv.innerHTML = "";

  if (data.length === 0) {
    threadsDiv.innerHTML = "<p>No threads yet.</p>";
    return;
  }

  data.forEach(post => renderThread(post));
}

function renderThread(post) {
  const a = document.createElement("a");
  a.href = `thread.html?id=${post.id}`;
  a.className = "thread-link";

  a.innerHTML = `
    <div class="thread-card">
      <div class="thread-title">${escapeHtml(post.title)}</div>
      <div class="thread-meta">
        ${escapeHtml(post.username)} • ${new Date(post.created_at).toLocaleString()} • ${post.category}
      </div>
      <div class="thread-preview">
        ${escapeHtml(post.content.substring(0, 120))}
      </div>
    </div>
  `;

  threadsDiv.appendChild(a);
}

function setupRealtime() {
  supabase
    .channel("forum-realtime")
    .on("postgres_changes",
      { event: "INSERT", schema: "public", table: "forum_posts" },
      payload => {
        renderThread(payload.new);
      }
    )
    .subscribe();
}

loadThreads();
setupRealtime();
</script>

</body>
</html>