<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
--ok:#22c55e;
--warn:#f59e0b;
--down:#ef4444;
--bg:#0b1220;
--card:#111a2e;
--text:#e5e7eb;
}

*{box-sizing:border-box}
body{
margin:0;
font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
background:linear-gradient(180deg,#0b1220,#070b14);
color:var(--text);
}

.container{
max-width:900px;
margin:40px auto;
padding:20px;
}

.header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:30px;
}

.badge{
padding:6px 14px;
border-radius:999px;
font-weight:600;
font-size:14px;
}

.badge.ok{background:var(--ok)}
.badge.warn{background:var(--warn)}
.badge.down{background:var(--down)}

.section{
margin-top:30px;
}

.card{
background:var(--card);
border-radius:12px;
padding:16px;
margin-bottom:10px;
display:flex;
justify-content:space-between;
align-items:center;
}

.status-dot{
width:10px;
height:10px;
border-radius:50%;
display:inline-block;
margin-right:8px;
}

.footer{
margin-top:40px;
opacity:.6;
text-align:center;
font-size:13px;
}

.loading{
opacity:.6;
}

</style>
</head>
<body>

<div class="container">
<div class="header">
<h1>StudentStream Status</h1>
<div id="overallBadge" class="badge ok">Operational</div>
</div>

<div class="section">
<h2>Components</h2>
<div id="components" class="loading">Loading...</div>
</div>

<div class="section">
<h2>Incidents</h2>
<div id="incidents" class="loading">Loading...</div>
</div>

<div class="footer">
Live status â€¢ Powered by Supabase Realtime â€¢ StudentStream Â© 2026
</div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const componentsEl = document.getElementById("components");
const incidentsEl = document.getElementById("incidents");
const overallBadge = document.getElementById("overallBadge");

function statusColor(status){
if(status==="operational") return ["ok","ðŸŸ¢"];
if(status==="degraded") return ["warn","ðŸŸ¡"];
return ["down","ðŸ”´"];
}

async function loadComponents(){
const { data, error } = await supabase
.from("status_components")
.select("*")
.order("name");

if(error){
componentsEl.innerHTML = "Failed to load components";
return;
}

componentsEl.classList.remove("loading");
componentsEl.innerHTML = "";

let worst="operational";

data.forEach(c=>{
if(c.status==="down") worst="down";
else if(c.status==="degraded" && worst==="operational") worst="degraded";

const [cls] = statusColor(c.status);

const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<div>${c.name}</div>
<div><span class="status-dot" style="background:var(--${cls})"></span>${c.status}</div>
`;
componentsEl.appendChild(div);
});

setOverall(worst);
}

async function loadIncidents(){
const { data, error } = await supabase
.from("status_incidents")
.select("*")
.order("created_at",{ascending:false})
.limit(5);

incidentsEl.classList.remove("loading");
incidentsEl.innerHTML="";

if(error || data.length===0){
incidentsEl.innerHTML="<div class='card'>No active incidents</div>";
return;
}

data.forEach(i=>{
const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<div>
<strong>${i.title}</strong><br>
<small>${i.status}</small>
</div>
<div>${new Date(i.created_at).toLocaleString()}</div>
`;
incidentsEl.appendChild(div);
});
}

function setOverall(status){
const [cls]=statusColor(status);
overallBadge.className="badge "+cls;
overallBadge.textContent=status.charAt(0).toUpperCase()+status.slice(1);
}

/* realtime updates */
supabase.channel("status-live")
.on("postgres_changes",{event:"*",schema:"public",table:"status_components"},loadComponents)
.on("postgres_changes",{event:"*",schema:"public",table:"status_incidents"},loadIncidents)
.subscribe();

/* initial load */
loadComponents();
loadIncidents();

/* auto refresh safety */
setInterval(()=>{
loadComponents();
loadIncidents();
},30000);

</script>
</body>
</html>
