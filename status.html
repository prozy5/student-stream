<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
margin:0;
font-family: system-ui, -apple-system, BlinkMacSystemFont;
background: linear-gradient(135deg,#0f172a,#1e3a8a);
color:#fff;
}
.container{max-width:900px;margin:auto;padding:30px}
.card{background:#0b1220;border-radius:14px;padding:20px;margin-bottom:20px}
.component{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #1e293b}
.badge{padding:4px 10px;border-radius:999px;font-size:12px}
.ok{background:#22c55e}
.warn{background:#facc15;color:#000}
.down{background:#ef4444}
.incident{border-left:4px solid #f97316;padding-left:10px;margin-top:10px}
.footer{opacity:.6;font-size:12px;text-align:center;margin-top:40px}
</style>
</head>

<body>
<div class="container">
<h1>StudentStream Status</h1>
<div id="overall" class="badge ok">Loading...</div>

<div class="card">
<h2>Components</h2>
<div id="components">Loading...</div>
</div>

<div class="card">
<h2>Active Incidents</h2>
<div id="incidents">Loading...</div>
</div>

<div class="card">
<h2>Incident History</h2>
<div id="history">Loading...</div>
</div>

<div class="footer">
Live status · Powered by Supabase Realtime · StudentStream © 2026
</div>
</div>

<script>
const supabase = window.supabase.createClient(
"https://iabzmoxzbqzcqgypxctr.supabase.co",
"sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC"
);

const componentsDiv = document.getElementById("components");
const incidentsDiv = document.getElementById("incidents");
const historyDiv = document.getElementById("history");
const overallDiv = document.getElementById("overall");

function badgeClass(status){
if(status==="operational") return "ok";
if(status==="degraded") return "warn";
return "down";
}

async function loadComponents(){
const {data,error}=await supabase.from("status_components").select("*").order("name");
if(error){componentsDiv.innerHTML="Failed to load";return;}

componentsDiv.innerHTML="";
let allOk=true;

data.forEach(c=>{
if(c.status!=="operational") allOk=false;

componentsDiv.innerHTML+=`
<div class="component">
<span>${c.name}</span>
<span class="badge ${badgeClass(c.status)}">${c.status}</span>
</div>`;
});

overallDiv.textContent = allOk?"All Systems Operational":"Service Disruption";
overallDiv.className = "badge " + (allOk?"ok":"warn");
}

async function loadIncidents(){
const {data}=await supabase.from("status_incidents")
.select("*").is("resolved_at",null).order("created_at",{ascending:false});

incidentsDiv.innerHTML = data.length? "" : "No active incidents";

data.forEach(i=>{
incidentsDiv.innerHTML+=`
<div class="incident">
<strong>${i.title}</strong><br>
${i.description||""}<br>
<small>${new Date(i.created_at).toLocaleString()}</small>
</div>`;
});
}

async function loadHistory(){
const {data}=await supabase.from("status_incidents")
.select("*").not("resolved_at","is",null).order("created_at",{ascending:false}).limit(10);

historyDiv.innerHTML = data.length? "" : "No past incidents";

data.forEach(i=>{
historyDiv.innerHTML+=`
<div class="incident">
<strong>${i.title}</strong> (resolved)<br>
<small>${new Date(i.resolved_at).toLocaleString()}</small>
</div>`;
});
}

function realtime(){
supabase.channel("status-live")
.on("postgres_changes",{event:"*",schema:"public",table:"status_components"},loadComponents)
.on("postgres_changes",{event:"*",schema:"public",table:"status_incidents"},()=>{
loadIncidents();loadHistory();
})
.subscribe();
}

async function init(){
await loadComponents();
await loadIncidents();
await loadHistory();
realtime();
}

init();
</script>
</body>
</html>
