<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SS:I – Case Database</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg:#0b0f14;
  --panel:#121923;
  --border:#1f2a38;
  --text:#e6ecf2;
  --muted:#8aa0b6;
  --accent:#4aa3ff;
}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Arial}
body{margin:0;background:var(--bg);color:var(--text)}
header{padding:20px;border-bottom:1px solid var(--border);font-weight:700;letter-spacing:2px}
.container{display:flex;height:calc(100vh - 70px)}
.sidebar{width:350px;border-right:1px solid var(--border);overflow:auto}
.case-item{padding:15px;border-bottom:1px solid var(--border);cursor:pointer}
.case-item:hover{background:#16202c}
.case-item small{color:var(--muted)}
.main{flex:1;padding:25px;overflow:auto}
.panel{background:var(--panel);border:1px solid var(--border);padding:20px;border-radius:6px;margin-bottom:20px}
h2,h3{margin-top:0}
input,textarea,button{
  width:100%;padding:10px;background:#0e1520;color:var(--text);
  border:1px solid var(--border);border-radius:4px
}
button{background:var(--accent);border:none;color:#000;font-weight:700;cursor:pointer}
.timeline-item{border-left:3px solid var(--accent);padding-left:10px;margin-bottom:10px}
.hidden{display:none}
</style>
</head>
<body>

<header>STUDENTSTREAM INVESTIGATIONS – CASE DATABASE</header>

<div class="container">
  <div class="sidebar" id="caseList"></div>

  <div class="main">
    <div id="noCase" class="panel">
      <h2>Select a case file</h2>
      <p>Choose a case from the database to view details.</p>
    </div>

    <div id="caseView" class="hidden">

      <div class="panel">
        <h2 id="caseTitle"></h2>
        <p id="caseDesc"></p>
        <small id="caseMeta"></small>
      </div>

      <div class="panel">
        <h3>Timeline / Updates</h3>
        <div id="timeline"></div>
      </div>

      <div class="panel">
        <h3>Add Update</h3>
        <textarea id="updateText" placeholder="Enter investigation update..."></textarea>
        <br><br>
        <button onclick="postUpdate()">Submit Update</button>
        <p id="statusMsg"></p>
      </div>

    </div>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

let currentCaseId = null;

async function loadCases(){
  const { data } = await supabase.from("cases").select("*").order("created_at",{ascending:false});
  const list = document.getElementById("caseList");
  list.innerHTML = "";

  data.forEach(c=>{
    const div = document.createElement("div");
    div.className="case-item";
    div.innerHTML = `<strong>${c.title}</strong><br><small>${c.status || "OPEN"}</small>`;
    div.onclick=()=>openCase(c);
    list.appendChild(div);
  });
}

async function openCase(c){
  currentCaseId = c.id;
  document.getElementById("noCase").classList.add("hidden");
  document.getElementById("caseView").classList.remove("hidden");

  document.getElementById("caseTitle").textContent = c.title;
  document.getElementById("caseDesc").textContent = c.description;
  document.getElementById("caseMeta").textContent =
    `Status: ${c.status || "OPEN"} | Created: ${new Date(c.created_at).toLocaleString()}`;

  loadTimeline();
}

async function loadTimeline(){
  const { data } = await supabase
    .from("case_updates")
    .select("*")
    .eq("case_id", currentCaseId)
    .order("created_at",{ascending:false});

  const box = document.getElementById("timeline");
  box.innerHTML="";

  data.forEach(u=>{
    const div = document.createElement("div");
    div.className="timeline-item";
    div.innerHTML = `<strong>${new Date(u.created_at).toLocaleString()}</strong><br>${u.content}`;
    box.appendChild(div);
  });
}

async function postUpdate(){
  const txt = document.getElementById("updateText").value.trim();
  if(!txt) return;

  const { error } = await supabase.from("case_updates").insert({
    case_id: currentCaseId,
    content: txt
  });

  if(error){
    document.getElementById("statusMsg").textContent = error.message;
  } else {
    document.getElementById("statusMsg").textContent = "Update posted.";
    document.getElementById("updateText").value="";
    loadTimeline();
  }
}

loadCases();
</script>

</body>
</html>