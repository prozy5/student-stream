<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0f16;color:#e5e7eb}
header{padding:20px;background:#111827;border-bottom:1px solid #1f2933}
h1{margin:0;color:#60a5fa}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:#111827;border:1px solid #1f2933;border-radius:10px;padding:15px;margin-bottom:12px}
.status-ok{color:#22c55e}
.status-bad{color:#ef4444}
.status-warn{color:#f59e0b}
.small{opacity:.7;font-size:13px}
.incident{border-left:4px solid #f59e0b;padding-left:12px}
footer{text-align:center;opacity:.6;padding:30px}
.loader{opacity:.6}
</style>
</head>
<body>

<header>
  <h1>StudentStream Status</h1>
  <div class="small">System status & uptime</div>
</header>

<div class="container">

<h2>System Components</h2>
<div id="components" class="loader">Loading…</div>

<h2>Active Incidents</h2>
<div id="incidents" class="loader">Loading…</div>

<h2>Incident History</h2>
<div id="history" class="loader">Loading…</div>

<h2>Uptime</h2>
<div id="uptime" class="loader">Loading…</div>

</div>

<footer>
StudentStream © 2026
</footer>

<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"; // keep using anon key

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function statusClass(s){
  if(s==="operational") return "status-ok";
  if(s==="degraded") return "status-warn";
  return "status-bad";
}

function safe(text){
  return text ?? "";
}

/* ---------------- COMPONENTS ---------------- */

async function loadComponents(){
  const el = document.getElementById("components");
  el.innerHTML = "Loading…";

  const {data, error} = await supabase
    .from("status_components")
    .select("*")
    .order("order_index",{ascending:true});

  if(error || !data){
    el.innerHTML = "<div class='small'>Unable to load components</div>";
    return;
  }

  el.innerHTML = "";

  data.forEach(c=>{
    el.innerHTML += `
      <div class="card">
        <strong>${safe(c.name)}</strong>
        <div class="small">${safe(c.description)}</div>
        <div class="${statusClass(c.status)}">${c.status.toUpperCase()}</div>
      </div>
    `;
  });
}

/* ---------------- INCIDENTS ---------------- */

async function loadIncidents(){
  const el=document.getElementById("incidents");
  el.innerHTML="Loading…";

  const {data,error} = await supabase
    .from("status_incidents")
    .select("*")
    .is("resolved_at", null)
    .order("created_at",{ascending:false});

  if(error || !data){
    el.innerHTML="<div class='small'>Unable to load incidents</div>";
    return;
  }

  if(!data.length){
    el.innerHTML="<div class='small'>No active incidents</div>";
    return;
  }

  el.innerHTML="";

  data.forEach(i=>{
    el.innerHTML+=`
      <div class="card incident">
        <strong>${safe(i.title)}</strong>
        <div>${safe(i.description)}</div>
        <div class="small">${new Date(i.created_at).toLocaleString()}</div>
      </div>
    `;
  });
}

/* ---------------- HISTORY ---------------- */

async function loadHistory(){
  const el=document.getElementById("history");
  el.innerHTML="Loading…";

  const {data,error} = await supabase
    .from("status_incidents")
    .select("*")
    .not("resolved_at","is",null)
    .order("created_at",{ascending:false})
    .limit(5);

  if(error || !data){
    el.innerHTML="<div class='small'>Unable to load history</div>";
    return;
  }

  if(!data.length){
    el.innerHTML="<div class='small'>No past incidents</div>";
    return;
  }

  el.innerHTML="";

  data.forEach(i=>{
    el.innerHTML+=`
      <div class="card">
        <strong>${safe(i.title)}</strong>
        <div class="small">Resolved ${new Date(i.resolved_at).toLocaleString()}</div>
      </div>
    `;
  });
}

/* ---------------- UPTIME ---------------- */

async function loadUptime(){
  const el=document.getElementById("uptime");

  try{
    const {data} = await supabase.rpc("calculate_uptime");

    if(!data){
      el.innerHTML = "Uptime tracking active";
      return;
    }

    el.innerHTML = `<pre>${JSON.stringify(data,null,2)}</pre>`;
  }catch{
    el.innerHTML = "Uptime tracking active";
  }
}

/* ---------------- REFRESH ---------------- */

async function refresh(){
  await loadComponents();
  await loadIncidents();
  await loadHistory();
  await loadUptime();
}

refresh();
setInterval(refresh, 15000);

/* ---------------- REALTIME ---------------- */

supabase
  .channel("status-components")
  .on("postgres_changes",
    {event:"*",schema:"public",table:"status_components"},
    refresh
  )
  .on("postgres_changes",
    {event:"*",schema:"public",table:"status_incidents"},
    refresh
  )
  .subscribe();

</script>

</body>
</html>