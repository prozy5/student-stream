<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Case File</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1 id="title"></h1>
<p id="description"></p>

<h2>Evidence Files</h2>
<ul id="files"></ul>

<h2>Agent Comments</h2>
<div id="comments"></div>

<textarea id="commentText" placeholder="Add comment..."></textarea>
<button onclick="postComment()">Submit</button>

<script type="module">
import { supabase } from './supabase.js';

const params = new URLSearchParams(location.search);
const caseId = params.get('id');

async function loadCase() {
  const { data } = await supabase.from('cases').select('*').eq('id', caseId).single();
  document.getElementById('title').textContent = data.title;
  document.getElementById('description').textContent = data.description;
}

async function loadFiles() {
  const { data } = await supabase.from('case_files').select('*').eq('case_id', caseId);

  const ul = document.getElementById('files');
  ul.innerHTML = '';

  for (let f of data) {
    const { data: url } = supabase.storage.from('case-files').getPublicUrl(f.file_path);
    const li = document.createElement('li');
    li.innerHTML = `<a href="${url.publicUrl}" target="_blank">${f.file_name}</a>`;
    ul.appendChild(li);
  }
}

async function loadComments() {
  const { data } = await supabase.from('case_comments').select('*').eq('case_id', caseId).order('created_at');

  const div = document.getElementById('comments');
  div.innerHTML = '';
  data.forEach(c => {
    div.innerHTML += `<p><b>${c.author}</b>: ${c.comment}</p>`;
  });
}

window.postComment = async function () {
  const text = document.getElementById('commentText').value;
  await supabase.from('case_comments').insert({
    case_id: caseId,
    author: "Agent",
    comment: text
  });
  document.getElementById('commentText').value = '';
  loadComments();
}

loadCase();
loadFiles();
loadComments();
</script>
</body>
</html>